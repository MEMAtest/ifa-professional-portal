import assert from 'node:assert/strict'
import { test } from 'node:test'

import { mapSuitabilityToClientVulnerability } from '@/lib/suitability/vulnerability/mapSuitabilityToClientVulnerability'

test('mapSuitabilityToClientVulnerability: not vulnerable -> annual review', () => {
  const now = '2025-01-01T10:00:00.000Z'
  const result = mapSuitabilityToClientVulnerability({
    formData: {
      personal_information: { age: 40 },
      financial_situation: { monthly_expenses: 1000, emergency_fund: 8000 },
      vulnerability_assessment: {
        health_conditions: 'No',
        life_events: ['None'],
        support_needed: ['None'],
        financial_confidence: 'High'
      }
    } as any,
    nowISO: now,
    assessorId: 'user-1'
  })

  assert.equal(result.is_vulnerable, false)
  assert.deepEqual(result.vulnerabilityFactors, [])
  assert.equal(result.assessmentDate, now)
  assert.equal(result.assessorId, 'user-1')
  assert.equal(result.reviewDate.slice(0, 10), '2026-01-01')
})

test('mapSuitabilityToClientVulnerability: health + life events -> frequent review', () => {
  const now = '2025-01-01T10:00:00.000Z'
  const result = mapSuitabilityToClientVulnerability({
    formData: {
      personal_information: { age: 78 },
      financial_situation: { monthly_expenses: 1000, emergency_fund: 1500, net_worth: 40000, monthly_surplus: -200 },
      vulnerability_assessment: {
        health_conditions: 'Yes',
        life_events: ['Bereavement'],
        support_needed: ['Large Print Documents', 'Third Party Support'],
        financial_confidence: 'Low',
        third_party_authority: 'Yes',
        emotional_support: ['Family Involvement'],
        vulnerability_notes: 'Client requested additional time.'
      }
    } as any,
    nowISO: now
  })

  assert.equal(result.is_vulnerable, true)
  assert.ok(result.vulnerabilityFactors.includes('health'))
  assert.ok(result.vulnerabilityFactors.includes('life_events'))
  assert.ok(result.vulnerabilityFactors.includes('resilience'))
  assert.ok(result.vulnerabilityFactors.includes('capability'))
  assert.ok(result.supportNeeds.includes('Large Print Documents'))
  assert.ok(result.supportNeeds.includes('Family Involvement'))
  assert.equal(result.reviewDate.slice(0, 10), '2025-04-01')
  assert.match(result.assessmentNotes, /additional time/i)
})

