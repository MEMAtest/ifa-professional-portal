// components/compliance/VulnerabilityRegister.tsx
// ================================================================
// Vulnerability Register - Client vulnerability tracking (Consumer Duty)
// Enhanced to pull real flagged clients from clients table
// ================================================================

'use client'

import React, { useState, useEffect, useCallback } from 'react'
import {
  UserX,
  Plus,
  Search,
  Download,
  Eye,
  CheckCircle,
  AlertTriangle,
  X,
  Calendar,
  Heart,
  RefreshCw,
  Clock,
  User,
  Brain,
  Briefcase,
  ShieldAlert,
  PlusCircle,
  ChevronRight,
  LayoutGrid
} from 'lucide-react'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/Button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card'
import { Badge } from '@/components/ui/Badge'
import { useToast } from '@/hooks/use-toast'
import { useRouter } from 'next/navigation'
import { WorkflowBoard, StatusPipeline, CommentThread, OwnerPicker, WORKFLOW_CONFIGS } from './workflow'
import type { WorkflowItem } from './workflow'
import { CreateTaskModal } from '@/modules/tasks/components/CreateTaskModal'
import { useCreateTask, useSourceTasks } from '@/modules/tasks/hooks/useTasks'
import {
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  ResponsiveContainer
} from 'recharts'

interface Vulnerability {
  id: string
  firm_id: string
  client_id: string
  assessment_date: string
  vulnerability_type: 'health' | 'life_events' | 'resilience' | 'capability'
  severity: 'low' | 'medium' | 'high'
  description: string | null
  support_measures: string | null
  review_frequency: 'monthly' | 'quarterly' | 'annually'
  next_review_date: string | null
  status: 'active' | 'monitoring' | 'resolved'
  assigned_to: string | null
  priority: 'low' | 'medium' | 'high' | 'urgent'
  created_by: string | null
  created_at: string
  updated_at: string
  clients?: {
    id: string
    client_ref: string
    personal_details: {
      firstName: string
      lastName: string
      title?: string
    }
  }
  assigned_user?: {
    id: string
    first_name: string | null
    last_name: string | null
    avatar_url: string | null
  }
}

// Combined client vulnerability data - merges clients flagged as vulnerable with register entries
interface CombinedVulnerability {
  clientId: string
  clientRef: string
  clientName: string
  // From clients table (vulnerability_assessment JSONB)
  isVulnerableFlag: boolean
  vulnerabilityFactors: string[]
  supportNeeds: string[]
  assessmentNotes: string
  flaggedDate?: string
  // From vulnerability_register table (if entry exists)
  hasRegisterEntry: boolean
  registerEntry?: Vulnerability
}

// Chart colors
const COLORS = {
  health: '#ef4444',
  life_events: '#f97316',
  resilience: '#eab308',
  capability: '#3b82f6'
}

const SEVERITY_COLORS = {
  high: '#ef4444',
  medium: '#f97316',
  low: '#22c55e'
}

interface Props {
  onStatsChange?: () => void
}

export default function VulnerabilityRegister({ onStatsChange }: Props) {
  const supabase = createClient()
  const { toast } = useToast()
  const router = useRouter()

  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([])
  const [combinedData, setCombinedData] = useState<CombinedVulnerability[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState<string>('all')
  const [typeFilter, setTypeFilter] = useState<string>('all')
  const [viewMode, setViewMode] = useState<'list' | 'charts' | 'workflow'>('list')
  const [showCreateModal, setShowCreateModal] = useState(false)
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | null>(null)
  const [selectedClientForAssessment, setSelectedClientForAssessment] = useState<CombinedVulnerability | null>(null)

  const loadVulnerabilities = useCallback(async () => {
    try {
      setLoading(true)

      // 1. Load all clients flagged as vulnerable from the clients table
      const { data: vulnerableClients, error: clientsError } = await supabase
        .from('clients')
        .select('id, client_ref, personal_details, vulnerability_assessment')
        .not('vulnerability_assessment', 'is', null)

      // 2. Load all vulnerability register entries
      let registerQuery = supabase
        .from('vulnerability_register')
        .select(`
          *,
          clients (
            id,
            client_ref,
            personal_details
          ),
          assigned_user:assigned_to (
            id,
            first_name,
            last_name,
            avatar_url
          )
        `)
        .order('assessment_date', { ascending: false })

      if (statusFilter !== 'all') {
        registerQuery = registerQuery.eq('status', statusFilter)
      }
      if (typeFilter !== 'all') {
        registerQuery = registerQuery.eq('vulnerability_type', typeFilter)
      }

      const { data: registerData, error: registerError } = await registerQuery

      if (clientsError) {
        console.error('Error loading vulnerable clients:', clientsError)
      }
      if (registerError) {
        console.error('Error loading vulnerability register:', registerError)
      }

      setVulnerabilities(registerData || [])

      // 3. Combine data: merge clients flagged as vulnerable with register entries
      const combined: CombinedVulnerability[] = []
      const processedClientIds = new Set<string>()

      // First, process all vulnerable clients from the clients table
      if (vulnerableClients) {
        for (const client of vulnerableClients) {
          const va = client.vulnerability_assessment || {}
          const isVulnerable = va.is_vulnerable === true || va.isVulnerable === true ||
                              (Array.isArray(va.vulnerabilityFactors) && va.vulnerabilityFactors.length > 0)

          if (!isVulnerable) continue

          const pd = client.personal_details || {}
          const clientName = `${pd.title ? pd.title + ' ' : ''}${pd.firstName || ''} ${pd.lastName || ''}`.trim() || client.client_ref

          // Find matching register entry
          const registerEntry = registerData?.find((r: any) => r.client_id === client.id)

          combined.push({
            clientId: client.id,
            clientRef: client.client_ref,
            clientName,
            isVulnerableFlag: true,
            vulnerabilityFactors: va.vulnerabilityFactors || [],
            supportNeeds: va.supportNeeds || [],
            assessmentNotes: va.assessmentNotes || '',
            flaggedDate: va.assessmentDate || va.lastAssessed,
            hasRegisterEntry: !!registerEntry,
            registerEntry: registerEntry || undefined
          })
          processedClientIds.add(client.id)
        }
      }

      // Then, add any register entries for clients not already processed
      if (registerData) {
        for (const entry of registerData) {
          if (!processedClientIds.has(entry.client_id)) {
            const pd = entry.clients?.personal_details || {}
            const clientName = `${pd.title ? pd.title + ' ' : ''}${pd.firstName || ''} ${pd.lastName || ''}`.trim() ||
                              entry.clients?.client_ref || 'Unknown'

            combined.push({
              clientId: entry.client_id,
              clientRef: entry.clients?.client_ref || '',
              clientName,
              isVulnerableFlag: false,
              vulnerabilityFactors: [],
              supportNeeds: [],
              assessmentNotes: '',
              hasRegisterEntry: true,
              registerEntry: entry
            })
          }
        }
      }

      setCombinedData(combined)
    } catch (error) {
      console.error('Error loading vulnerabilities:', error)
      setVulnerabilities([])
      setCombinedData([])
    } finally {
      setLoading(false)
    }
  }, [supabase, statusFilter, typeFilter])

  useEffect(() => {
    loadVulnerabilities()
  }, [loadVulnerabilities])

  // Filter combined data based on search
  const filteredCombined = combinedData.filter(v => {
    if (!searchTerm) return true
    return v.clientName.toLowerCase().includes(searchTerm.toLowerCase()) ||
           v.clientRef.toLowerCase().includes(searchTerm.toLowerCase())
  })

  // Legacy filter for backwards compatibility
  const filteredVulnerabilities = vulnerabilities.filter(v => {
    if (!searchTerm) return true
    const clientName = getClientName(v)
    return clientName.toLowerCase().includes(searchTerm.toLowerCase())
  })

  const getOwnerName = (vulnerability: Vulnerability): string => {
    const owner = vulnerability.assigned_user
    if (!owner) return 'Unassigned'
    return `${owner.first_name || ''} ${owner.last_name || ''}`.trim() || 'Unassigned'
  }

  const workflowItems: WorkflowItem[] = filteredVulnerabilities.map((vulnerability) => ({
    id: vulnerability.id,
    sourceType: 'vulnerability',
    sourceId: vulnerability.id,
    title: getClientName(vulnerability),
    subtitle: getTypeLabel(vulnerability.vulnerability_type),
    status: vulnerability.status,
    priority: vulnerability.priority || 'medium',
    ownerId: vulnerability.assigned_to || null,
    ownerName: getOwnerName(vulnerability),
    commentCount: 0,
    dueDate: vulnerability.next_review_date || undefined,
    clientId: vulnerability.client_id,
  }))

  const handleWorkflowStatusChange = async (item: WorkflowItem, status: string) => {
    try {
      const { error } = await supabase
        .from('vulnerability_register')
        .update({ status })
        .eq('id', item.id)
      if (error) throw error
      await loadVulnerabilities()
      onStatsChange?.()
    } catch (error) {
      console.error('Error updating vulnerability status:', error)
      toast({
        title: 'Error',
        description: 'Failed to update vulnerability status',
        variant: 'destructive'
      })
    }
  }

  // Chart data calculations
  const chartData = {
    // Type distribution from register entries
    typeDistribution: [
      { name: 'Health', value: vulnerabilities.filter(v => v.vulnerability_type === 'health' && v.status !== 'resolved').length, color: COLORS.health },
      { name: 'Life Events', value: vulnerabilities.filter(v => v.vulnerability_type === 'life_events' && v.status !== 'resolved').length, color: COLORS.life_events },
      { name: 'Resilience', value: vulnerabilities.filter(v => v.vulnerability_type === 'resilience' && v.status !== 'resolved').length, color: COLORS.resilience },
      { name: 'Capability', value: vulnerabilities.filter(v => v.vulnerability_type === 'capability' && v.status !== 'resolved').length, color: COLORS.capability }
    ].filter(d => d.value > 0),

    // Severity distribution
    severityDistribution: [
      { name: 'High', value: vulnerabilities.filter(v => v.severity === 'high' && v.status !== 'resolved').length, color: SEVERITY_COLORS.high },
      { name: 'Medium', value: vulnerabilities.filter(v => v.severity === 'medium' && v.status !== 'resolved').length, color: SEVERITY_COLORS.medium },
      { name: 'Low', value: vulnerabilities.filter(v => v.severity === 'low' && v.status !== 'resolved').length, color: SEVERITY_COLORS.low }
    ].filter(d => d.value > 0),

    // Status distribution
    statusDistribution: [
      { name: 'Active', value: vulnerabilities.filter(v => v.status === 'active').length },
      { name: 'Monitoring', value: vulnerabilities.filter(v => v.status === 'monitoring').length },
      { name: 'Resolved', value: vulnerabilities.filter(v => v.status === 'resolved').length }
    ],

    // Type by severity (for stacked bar chart)
    typeBySeverity: [
      {
        type: 'Health',
        high: vulnerabilities.filter(v => v.vulnerability_type === 'health' && v.severity === 'high' && v.status !== 'resolved').length,
        medium: vulnerabilities.filter(v => v.vulnerability_type === 'health' && v.severity === 'medium' && v.status !== 'resolved').length,
        low: vulnerabilities.filter(v => v.vulnerability_type === 'health' && v.severity === 'low' && v.status !== 'resolved').length
      },
      {
        type: 'Life Events',
        high: vulnerabilities.filter(v => v.vulnerability_type === 'life_events' && v.severity === 'high' && v.status !== 'resolved').length,
        medium: vulnerabilities.filter(v => v.vulnerability_type === 'life_events' && v.severity === 'medium' && v.status !== 'resolved').length,
        low: vulnerabilities.filter(v => v.vulnerability_type === 'life_events' && v.severity === 'low' && v.status !== 'resolved').length
      },
      {
        type: 'Resilience',
        high: vulnerabilities.filter(v => v.vulnerability_type === 'resilience' && v.severity === 'high' && v.status !== 'resolved').length,
        medium: vulnerabilities.filter(v => v.vulnerability_type === 'resilience' && v.severity === 'medium' && v.status !== 'resolved').length,
        low: vulnerabilities.filter(v => v.vulnerability_type === 'resilience' && v.severity === 'low' && v.status !== 'resolved').length
      },
      {
        type: 'Capability',
        high: vulnerabilities.filter(v => v.vulnerability_type === 'capability' && v.severity === 'high' && v.status !== 'resolved').length,
        medium: vulnerabilities.filter(v => v.vulnerability_type === 'capability' && v.severity === 'medium' && v.status !== 'resolved').length,
        low: vulnerabilities.filter(v => v.vulnerability_type === 'capability' && v.severity === 'low' && v.status !== 'resolved').length
      }
    ]
  }

  const getClientName = (vulnerability: Vulnerability): string => {
    if (!vulnerability.clients?.personal_details) return 'Unknown Client'
    const { firstName, lastName, title } = vulnerability.clients.personal_details
    return `${title ? title + ' ' : ''}${firstName || ''} ${lastName || ''}`.trim() ||
           vulnerability.clients.client_ref || 'Unknown Client'
  }

  const getTypeIcon = (type: Vulnerability['vulnerability_type']) => {
    const icons = {
      health: Heart,
      life_events: Briefcase,
      resilience: ShieldAlert,
      capability: Brain
    }
    return icons[type]
  }

  const getTypeLabel = (type: Vulnerability['vulnerability_type']): string => {
    const labels = {
      health: 'Health',
      life_events: 'Life Events',
      resilience: 'Resilience',
      capability: 'Capability'
    }
    return labels[type]
  }

  const getTypeDescription = (type: Vulnerability['vulnerability_type']): string => {
    const descriptions = {
      health: 'Physical or mental health conditions',
      life_events: 'Bereavement, divorce, job loss',
      resilience: 'Low financial resilience',
      capability: 'Low financial literacy or cognitive issues'
    }
    return descriptions[type]
  }

  const getSeverityBadge = (severity: Vulnerability['severity']) => {
    const config = {
      low: { color: 'bg-green-100 text-green-700', label: 'Low' },
      medium: { color: 'bg-yellow-100 text-yellow-700', label: 'Medium' },
      high: { color: 'bg-red-100 text-red-700', label: 'High' }
    }
    const { color, label } = config[severity]
    return <span className={`px-2 py-1 rounded text-xs font-medium ${color}`}>{label}</span>
  }

  const getStatusBadge = (status: Vulnerability['status']) => {
    const config = {
      active: { variant: 'destructive' as const, label: 'Active', icon: AlertTriangle },
      monitoring: { variant: 'secondary' as const, label: 'Monitoring', icon: Eye },
      resolved: { variant: 'default' as const, label: 'Resolved', icon: CheckCircle }
    }
    const { variant, label, icon: Icon } = config[status]
    return (
      <Badge variant={variant} className="flex items-center space-x-1">
        <Icon className="h-3 w-3" />
        <span>{label}</span>
      </Badge>
    )
  }

  const formatDate = (dateString: string | null): string => {
    if (!dateString) return '-'
    return new Date(dateString).toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    })
  }

  const isReviewDue = (nextReviewDate: string | null): boolean => {
    if (!nextReviewDate) return false
    return new Date(nextReviewDate) <= new Date()
  }

  const isReviewSoon = (nextReviewDate: string | null): boolean => {
    if (!nextReviewDate) return false
    const reviewDate = new Date(nextReviewDate)
    const today = new Date()
    const daysUntilReview = Math.ceil((reviewDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
    return daysUntilReview <= 14 && daysUntilReview > 0
  }

  const handleExportCSV = () => {
    const headers = ['Client', 'Type', 'Severity', 'Status', 'Assessment Date', 'Next Review', 'Support Measures']
    const rows = vulnerabilities.map(v => [
      getClientName(v),
      getTypeLabel(v.vulnerability_type),
      v.severity,
      v.status,
      formatDate(v.assessment_date),
      formatDate(v.next_review_date),
      v.support_measures || ''
    ])

    const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n')
    const blob = new Blob([csvContent], { type: 'text/csv' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `vulnerability_register_${new Date().toISOString().split('T')[0]}.csv`
    a.click()
    URL.revokeObjectURL(url)

    toast({
      title: 'Exported',
      description: 'Vulnerability register exported to CSV'
    })
  }

  // Stats - Enhanced to include combined data
  const activeCount = vulnerabilities.filter(v => v.status === 'active').length
  const reviewsDueCount = vulnerabilities.filter(v => isReviewDue(v.next_review_date) && v.status !== 'resolved').length
  const flaggedWithoutRegister = combinedData.filter(c => c.isVulnerableFlag && !c.hasRegisterEntry).length
  const totalVulnerableClients = combinedData.length

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Summary Banner - Flagged clients needing assessment */}
      {flaggedWithoutRegister > 0 && (
        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <UserX className="h-5 w-5 text-purple-600" />
            <div>
              <p className="font-medium text-purple-800">
                {flaggedWithoutRegister} client{flaggedWithoutRegister !== 1 ? 's' : ''} flagged as vulnerable but not yet assessed
              </p>
              <p className="text-sm text-purple-600">
                These clients have been marked vulnerable in their profile but need a formal vulnerability assessment
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Quick Stats - Updated with total vulnerable count */}
      <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
        <Card className="bg-purple-50 border-purple-200">
          <CardContent className="p-4">
            <div className="flex items-center space-x-3">
              <div className="p-2 rounded-lg bg-purple-100">
                <UserX className="h-5 w-5 text-purple-600" />
              </div>
              <div>
                <p className="text-xs text-gray-500 uppercase">Total Vulnerable</p>
                <p className="text-lg font-bold text-purple-700">{totalVulnerableClients}</p>
              </div>
            </div>
          </CardContent>
        </Card>
        {(['health', 'life_events', 'resilience', 'capability'] as const).map(type => {
          const Icon = getTypeIcon(type)
          const count = vulnerabilities.filter(v => v.vulnerability_type === type && v.status !== 'resolved').length
          return (
            <Card key={type} className="cursor-pointer hover:shadow-md" onClick={() => setTypeFilter(type)}>
              <CardContent className="p-4">
                <div className="flex items-center space-x-3">
                  <div className="p-2 rounded-lg bg-purple-100">
                    <Icon className="h-5 w-5 text-purple-600" />
                  </div>
                  <div>
                    <p className="text-xs text-gray-500 uppercase">{getTypeLabel(type)}</p>
                    <p className="text-lg font-bold">{count}</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          )
        })}
      </div>

      {/* Header with View Toggle */}
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <input
              type="text"
              placeholder="Search clients..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 pr-4 py-2 border rounded-lg text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="border rounded-lg px-3 py-2 text-sm"
          >
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="monitoring">Monitoring</option>
            <option value="resolved">Resolved</option>
          </select>

          <select
            value={typeFilter}
            onChange={(e) => setTypeFilter(e.target.value)}
            className="border rounded-lg px-3 py-2 text-sm"
          >
            <option value="all">All Types</option>
            <option value="health">Health</option>
            <option value="life_events">Life Events</option>
            <option value="resilience">Resilience</option>
            <option value="capability">Capability</option>
          </select>

          {/* View Mode Toggle */}
          <div className="flex border rounded-lg overflow-hidden">
            <button
              onClick={() => setViewMode('list')}
              className={`px-3 py-2 text-sm ${viewMode === 'list' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
            >
              List
            </button>
            <button
              onClick={() => setViewMode('charts')}
              className={`px-3 py-2 text-sm ${viewMode === 'charts' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
            >
              Charts
            </button>
            <button
              onClick={() => setViewMode('workflow')}
              className={`px-3 py-2 text-sm ${viewMode === 'workflow' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
            >
              Workflow
            </button>
          </div>
        </div>

        <div className="flex items-center space-x-3">
          <Button variant="outline" onClick={handleExportCSV}>
            <Download className="h-4 w-4 mr-2" />
            Export CSV
          </Button>
          <Button onClick={() => setShowCreateModal(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Record Vulnerability
          </Button>
        </div>
      </div>

      {/* Reviews Due Alert */}
      {reviewsDueCount > 0 && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <AlertTriangle className="h-5 w-5 text-yellow-600" />
            <div>
              <p className="font-medium text-yellow-800">{reviewsDueCount} vulnerability review{reviewsDueCount !== 1 ? 's' : ''} due</p>
              <p className="text-sm text-yellow-600">Clients require reassessment of their vulnerability status</p>
            </div>
          </div>
          <Button variant="outline" size="sm" onClick={() => setStatusFilter('active')}>
            View Due Reviews
          </Button>
        </div>
      )}

      {/* Charts View */}
      {viewMode === 'charts' && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Type Distribution Pie Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm font-medium">Vulnerability by Type</CardTitle>
            </CardHeader>
            <CardContent>
              {chartData.typeDistribution.length > 0 ? (
                <ResponsiveContainer width="100%" height={250}>
                  <PieChart>
                    <Pie
                      data={chartData.typeDistribution}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={({ name, value }) => `${name}: ${value}`}
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {chartData.typeDistribution.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="flex items-center justify-center h-[250px] text-gray-400">
                  No data to display
                </div>
              )}
            </CardContent>
          </Card>

          {/* Severity Distribution Pie Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm font-medium">Vulnerability by Severity</CardTitle>
            </CardHeader>
            <CardContent>
              {chartData.severityDistribution.length > 0 ? (
                <ResponsiveContainer width="100%" height={250}>
                  <PieChart>
                    <Pie
                      data={chartData.severityDistribution}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={({ name, value }) => `${name}: ${value}`}
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {chartData.severityDistribution.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="flex items-center justify-center h-[250px] text-gray-400">
                  No data to display
                </div>
              )}
            </CardContent>
          </Card>

          {/* Type by Severity Stacked Bar Chart */}
          <Card className="md:col-span-2">
            <CardHeader>
              <CardTitle className="text-sm font-medium">Type by Severity Breakdown</CardTitle>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={chartData.typeBySeverity}>
                  <XAxis dataKey="type" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="high" stackId="a" fill={SEVERITY_COLORS.high} name="High" />
                  <Bar dataKey="medium" stackId="a" fill={SEVERITY_COLORS.medium} name="Medium" />
                  <Bar dataKey="low" stackId="a" fill={SEVERITY_COLORS.low} name="Low" />
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>
      )}

      {viewMode === 'workflow' && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center space-x-2">
              <UserX className="h-5 w-5" />
              <span>Vulnerability Workflow ({filteredVulnerabilities.length})</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <WorkflowBoard
              columns={WORKFLOW_CONFIGS.vulnerability.stages}
              items={workflowItems}
              onItemClick={(item) => {
                const record = vulnerabilities.find((v) => v.id === item.id)
                if (record) setSelectedVulnerability(record)
              }}
              onStatusChange={handleWorkflowStatusChange}
              emptyMessage="No vulnerability records in this workflow"
            />
          </CardContent>
        </Card>
      )}

      {/* Combined Vulnerable Clients List */}
      {viewMode === 'list' && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <div className="flex items-center space-x-2">
                <UserX className="h-5 w-5" />
                <span>All Vulnerable Clients ({filteredCombined.length})</span>
              </div>
            </CardTitle>
          </CardHeader>
          <CardContent>
            {filteredCombined.length === 0 ? (
              <div className="text-center py-12">
                <UserX className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                <p className="text-gray-500 text-lg">No vulnerable clients found</p>
                <p className="text-gray-400 mt-1">
                  {searchTerm ? 'Try a different search term' : 'No clients have been flagged as vulnerable'}
                </p>
              </div>
            ) : (
              <div className="divide-y">
                {filteredCombined.map((client) => {
                  const entry = client.registerEntry
                  const Icon = entry ? getTypeIcon(entry.vulnerability_type) : UserX

                  return (
                    <div
                      key={client.clientId}
                      className={`p-4 hover:bg-gray-50 cursor-pointer ${
                        !client.hasRegisterEntry ? 'bg-purple-50 border-l-4 border-purple-400' : ''
                      }`}
                      onClick={() => {
                        if (entry) {
                          setSelectedVulnerability(entry)
                        } else {
                          setSelectedClientForAssessment(client)
                        }
                      }}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                          <div className={`p-2 rounded-lg ${
                            entry ? (
                              entry.severity === 'high' ? 'bg-red-100' :
                              entry.severity === 'medium' ? 'bg-yellow-100' :
                              'bg-green-100'
                            ) : 'bg-purple-100'
                          }`}>
                            <Icon className={`h-5 w-5 ${
                              entry ? (
                                entry.severity === 'high' ? 'text-red-600' :
                                entry.severity === 'medium' ? 'text-yellow-600' :
                                'text-green-600'
                              ) : 'text-purple-600'
                            }`} />
                          </div>

                          <div>
                            <div className="flex items-center space-x-2">
                              <h3 className="font-medium text-gray-900">{client.clientName}</h3>
                              {entry ? (
                                <>
                                  <Badge variant="outline" className="text-xs">
                                    {getTypeLabel(entry.vulnerability_type)}
                                  </Badge>
                                  {getSeverityBadge(entry.severity)}
                                </>
                              ) : (
                                <Badge variant="secondary" className="text-xs bg-purple-100 text-purple-700">
                                  Needs Assessment
                                </Badge>
                              )}
                            </div>
                            <div className="flex items-center space-x-4 mt-1 text-sm text-gray-500">
                              {client.vulnerabilityFactors.length > 0 && (
                                <span className="text-xs">
                                  Factors: {client.vulnerabilityFactors.slice(0, 2).join(', ')}
                                  {client.vulnerabilityFactors.length > 2 && ` +${client.vulnerabilityFactors.length - 2} more`}
                                </span>
                              )}
                              {entry && (
                                <>
                                  <span className="flex items-center">
                                    <Calendar className="h-3 w-3 mr-1" />
                                    Assessed: {formatDate(entry.assessment_date)}
                                  </span>
                                  {entry.next_review_date && entry.status !== 'resolved' && (
                                    <span className={`flex items-center ${
                                      isReviewDue(entry.next_review_date) ? 'text-red-600 font-medium' :
                                      isReviewSoon(entry.next_review_date) ? 'text-yellow-600' : ''
                                    }`}>
                                      <RefreshCw className="h-3 w-3 mr-1" />
                                      Review: {formatDate(entry.next_review_date)}
                                    </span>
                                  )}
                                </>
                              )}
                            </div>
                          </div>
                        </div>

                        <div className="flex items-center space-x-3">
                          {entry ? (
                            getStatusBadge(entry.status)
                          ) : (
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={(e) => {
                                e.stopPropagation()
                                setSelectedClientForAssessment(client)
                              }}
                            >
                              <PlusCircle className="h-4 w-4 mr-1" />
                              Add Assessment
                            </Button>
                          )}
                          <ChevronRight className="h-5 w-5 text-gray-400" />
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Legacy Vulnerability List - Hidden but kept for backwards compat */}
      {viewMode === 'list' && false && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center space-x-2">
              <UserX className="h-5 w-5" />
              <span>Vulnerability Register ({filteredVulnerabilities.length})</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            {filteredVulnerabilities.length === 0 ? (
              <div className="text-center py-12">
                <UserX className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                <p className="text-gray-500 text-lg">No vulnerability records found</p>
                <p className="text-gray-400 mt-1">
                  {statusFilter !== 'all' || typeFilter !== 'all'
                    ? 'Try changing the filters'
                    : 'Record your first vulnerability assessment'}
                </p>
              </div>
            ) : (
              <div className="divide-y">
                {filteredVulnerabilities.map((vulnerability) => {
                  const Icon = getTypeIcon(vulnerability.vulnerability_type)
                  const reviewDue = isReviewDue(vulnerability.next_review_date)
                  const reviewSoon = isReviewSoon(vulnerability.next_review_date)

                  return (
                    <div
                      key={vulnerability.id}
                      className={`p-4 hover:bg-gray-50 cursor-pointer ${
                        reviewDue && vulnerability.status !== 'resolved' ? 'bg-red-50' :
                        reviewSoon && vulnerability.status !== 'resolved' ? 'bg-yellow-50' : ''
                      }`}
                      onClick={() => setSelectedVulnerability(vulnerability)}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                          <div className={`p-2 rounded-lg ${
                            vulnerability.severity === 'high' ? 'bg-red-100' :
                            vulnerability.severity === 'medium' ? 'bg-yellow-100' :
                            'bg-green-100'
                          }`}>
                            <Icon className={`h-5 w-5 ${
                              vulnerability.severity === 'high' ? 'text-red-600' :
                              vulnerability.severity === 'medium' ? 'text-yellow-600' :
                              'text-green-600'
                            }`} />
                          </div>

                          <div>
                            <div className="flex items-center space-x-2">
                              <h3 className="font-medium text-gray-900">
                                {getClientName(vulnerability)}
                              </h3>
                              <Badge variant="outline" className="text-xs">
                                {getTypeLabel(vulnerability.vulnerability_type)}
                              </Badge>
                              {getSeverityBadge(vulnerability.severity)}
                            </div>
                            <div className="flex items-center space-x-4 mt-1 text-sm text-gray-500">
                              <span className="flex items-center">
                                <Calendar className="h-3 w-3 mr-1" />
                                Assessed: {formatDate(vulnerability.assessment_date)}
                              </span>
                              {vulnerability.next_review_date && vulnerability.status !== 'resolved' && (
                                <span className={`flex items-center ${
                                  reviewDue ? 'text-red-600 font-medium' :
                                  reviewSoon ? 'text-yellow-600' : ''
                                }`}>
                                  <RefreshCw className="h-3 w-3 mr-1" />
                                  Review: {formatDate(vulnerability.next_review_date)}
                                  {reviewDue && ' (Overdue)'}
                                </span>
                              )}
                            </div>
                            {vulnerability.support_measures && (
                              <p className="text-sm text-gray-600 mt-1 truncate max-w-md">
                                Support: {vulnerability.support_measures}
                              </p>
                            )}
                          </div>
                        </div>

                        <div className="flex items-center space-x-3">
                          {getStatusBadge(vulnerability.status)}
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Create Modal */}
      {showCreateModal && (
        <VulnerabilityFormModal
          onClose={() => setShowCreateModal(false)}
          onSaved={() => {
            setShowCreateModal(false)
            loadVulnerabilities()
            onStatsChange?.()
          }}
        />
      )}

      {/* Detail Modal */}
      {selectedVulnerability && (
        <VulnerabilityDetailModal
          vulnerability={selectedVulnerability}
          onClose={() => setSelectedVulnerability(null)}
          onSaved={() => {
            setSelectedVulnerability(null)
            loadVulnerabilities()
            onStatsChange?.()
          }}
        />
      )}

      {/* Assessment Modal for flagged clients without register entry */}
      {selectedClientForAssessment && (
        <VulnerabilityFormModal
          onClose={() => setSelectedClientForAssessment(null)}
          onSaved={() => {
            setSelectedClientForAssessment(null)
            loadVulnerabilities()
            onStatsChange?.()
          }}
          clientId={selectedClientForAssessment.clientId}
        />
      )}
    </div>
  )
}

// Vulnerability Form Modal
function VulnerabilityFormModal({
  onClose,
  onSaved,
  clientId
}: {
  onClose: () => void
  onSaved: () => void
  clientId?: string
}) {
  const supabase = createClient()
  const { toast } = useToast()

  const [clients, setClients] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [formData, setFormData] = useState({
    client_id: clientId || '',
    assigned_to: '',
    priority: 'medium' as Vulnerability['priority'],
    assessment_date: new Date().toISOString().split('T')[0],
    vulnerability_type: 'health' as Vulnerability['vulnerability_type'],
    severity: 'low' as Vulnerability['severity'],
    description: '',
    support_measures: '',
    review_frequency: 'quarterly' as Vulnerability['review_frequency']
  })

  useEffect(() => {
    const loadClients = async () => {
      const { data } = await supabase
        .from('clients')
        .select('id, client_ref, personal_details')
        .order('personal_details->firstName')
      setClients(data || [])
      setLoading(false)
    }
    loadClients()
  }, [supabase])

  const calculateNextReviewDate = (frequency: string): string => {
    const date = new Date()
    switch (frequency) {
      case 'monthly':
        date.setMonth(date.getMonth() + 1)
        break
      case 'quarterly':
        date.setMonth(date.getMonth() + 3)
        break
      case 'annually':
        date.setFullYear(date.getFullYear() + 1)
        break
    }
    return date.toISOString().split('T')[0]
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!formData.client_id) {
      toast({
        title: 'Error',
        description: 'Please select a client',
        variant: 'destructive'
      })
      return
    }

    setSubmitting(true)
    try {
      const { error } = await supabase
        .from('vulnerability_register')
        .insert({
          client_id: formData.client_id,
          assigned_to: formData.assigned_to || null,
          priority: formData.priority,
          assessment_date: formData.assessment_date,
          vulnerability_type: formData.vulnerability_type,
          severity: formData.severity,
          description: formData.description || null,
          support_measures: formData.support_measures || null,
          review_frequency: formData.review_frequency,
          next_review_date: calculateNextReviewDate(formData.review_frequency),
          status: 'active'
        })

      if (error) throw error

      toast({
        title: 'Recorded',
        description: 'Vulnerability assessment has been recorded'
      })
      onSaved()
    } catch (error) {
      console.error('Error creating vulnerability:', error)
      toast({
        title: 'Error',
        description: 'Failed to record vulnerability',
        variant: 'destructive'
      })
    } finally {
      setSubmitting(false)
    }
  }

  const getClientDisplayName = (client: any) => {
    const pd = client.personal_details || {}
    return `${pd.title || ''} ${pd.firstName || ''} ${pd.lastName || ''}`.trim() || client.client_ref
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b flex items-center justify-between">
          <h2 className="text-lg font-semibold">Record Vulnerability</h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            <X className="h-5 w-5" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Client *</label>
            <select
              value={formData.client_id}
              onChange={(e) => setFormData({ ...formData, client_id: e.target.value })}
              className="w-full border rounded-lg p-2 text-sm"
              disabled={loading || !!clientId}
            >
              <option value="">Select a client...</option>
              {clients.map(client => (
                <option key={client.id} value={client.id}>
                  {getClientDisplayName(client)}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Assessment Date *</label>
            <input
              type="date"
              value={formData.assessment_date}
              onChange={(e) => setFormData({ ...formData, assessment_date: e.target.value })}
              className="w-full border rounded-lg p-2 text-sm"
              required
            />
          </div>

          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Assigned To</label>
              <OwnerPicker
                value={formData.assigned_to || null}
                onChange={(value) => setFormData({ ...formData, assigned_to: value || '' })}
                compact
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
              <select
                value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: e.target.value as Vulnerability['priority'] })}
                className="w-full border rounded-lg p-2 text-sm"
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Vulnerability Type *</label>
            <select
              value={formData.vulnerability_type}
              onChange={(e) => setFormData({ ...formData, vulnerability_type: e.target.value as any })}
              className="w-full border rounded-lg p-2 text-sm"
            >
              <option value="health">Health - Physical or mental health conditions</option>
              <option value="life_events">Life Events - Bereavement, divorce, job loss</option>
              <option value="resilience">Resilience - Low financial resilience</option>
              <option value="capability">Capability - Low financial literacy or cognitive issues</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Severity *</label>
            <select
              value={formData.severity}
              onChange={(e) => setFormData({ ...formData, severity: e.target.value as any })}
              className="w-full border rounded-lg p-2 text-sm"
            >
              <option value="low">Low - Minor impact, standard support sufficient</option>
              <option value="medium">Medium - Moderate impact, enhanced support needed</option>
              <option value="high">High - Significant impact, specialist support required</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Describe the vulnerability..."
              className="w-full border rounded-lg p-2 text-sm min-h-[80px]"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Support Measures</label>
            <textarea
              value={formData.support_measures}
              onChange={(e) => setFormData({ ...formData, support_measures: e.target.value })}
              placeholder="What support measures have been put in place?"
              className="w-full border rounded-lg p-2 text-sm min-h-[80px]"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Review Frequency *</label>
            <select
              value={formData.review_frequency}
              onChange={(e) => setFormData({ ...formData, review_frequency: e.target.value as any })}
              className="w-full border rounded-lg p-2 text-sm"
            >
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="annually">Annually</option>
            </select>
          </div>

          {/* Linked Tasks */}
          <div className="rounded-lg border border-gray-200 bg-white p-4">
            <div className="flex items-center justify-between">
              <div className="text-sm font-semibold text-gray-800">Linked Tasks</div>
              <Button size="sm" onClick={() => setShowTaskModal(true)}>
                <Plus className="mr-2 h-4 w-4" />
                Create Task
              </Button>
            </div>
            <div className="mt-3 space-y-2">
              {linkedTasks?.tasks?.length ? (
                linkedTasks.tasks.map((task) => (
                  <div key={task.id} className="flex items-center justify-between rounded-md border border-gray-200 px-3 py-2 text-sm">
                    <div>
                      <p className="font-medium text-gray-800">{task.title}</p>
                      <p className="text-xs text-gray-500">{task.status.replace('_', ' ')}</p>
                    </div>
                    <Badge variant="secondary" className="capitalize">
                      {task.priority}
                    </Badge>
                  </div>
                ))
              ) : (
                <div className="rounded-md border border-dashed border-gray-200 px-3 py-4 text-center text-xs text-gray-400">
                  No linked tasks yet
                </div>
              )}
            </div>
          </div>

          {/* Comments */}
          <CommentThread sourceType="vulnerability" sourceId={vulnerability.id} />

          <div className="flex justify-end space-x-3 pt-4">
            <Button type="button" variant="outline" onClick={onClose}>Cancel</Button>
            <Button type="submit" disabled={submitting}>
              {submitting ? 'Saving...' : 'Record Vulnerability'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  )
}

// Vulnerability Detail Modal
function VulnerabilityDetailModal({
  vulnerability,
  onClose,
  onSaved
}: {
  vulnerability: Vulnerability
  onClose: () => void
  onSaved: () => void
}) {
  const supabase = createClient()
  const { toast } = useToast()
  const [showTaskModal, setShowTaskModal] = useState(false)
  const createTask = useCreateTask()
  const { data: linkedTasks } = useSourceTasks('vulnerability', vulnerability.id)

  const [formData, setFormData] = useState({
    status: vulnerability.status,
    assigned_to: vulnerability.assigned_to || '',
    priority: vulnerability.priority || 'medium',
    severity: vulnerability.severity,
    description: vulnerability.description || '',
    support_measures: vulnerability.support_measures || '',
    review_frequency: vulnerability.review_frequency,
    next_review_date: vulnerability.next_review_date || ''
  })
  const [saving, setSaving] = useState(false)

  const getClientName = (): string => {
    if (!vulnerability.clients?.personal_details) return 'Unknown Client'
    const { firstName, lastName, title } = vulnerability.clients.personal_details
    return `${title ? title + ' ' : ''}${firstName || ''} ${lastName || ''}`.trim() ||
           vulnerability.clients.client_ref || 'Unknown Client'
  }

  const formatDate = (dateString: string | null): string => {
    if (!dateString) return '-'
    return new Date(dateString).toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    })
  }

  const getTypeLabel = (type: Vulnerability['vulnerability_type']): string => {
    const labels = {
      health: 'Health',
      life_events: 'Life Events',
      resilience: 'Resilience',
      capability: 'Capability'
    }
    return labels[type]
  }

  const handleSave = async () => {
    setSaving(true)
    try {
      const { error } = await supabase
        .from('vulnerability_register')
        .update({
          status: formData.status,
          assigned_to: formData.assigned_to || null,
          priority: formData.priority,
          severity: formData.severity,
          description: formData.description || null,
          support_measures: formData.support_measures || null,
          review_frequency: formData.review_frequency,
          next_review_date: formData.next_review_date || null
        })
        .eq('id', vulnerability.id)

      if (error) throw error

      toast({
        title: 'Updated',
        description: 'Vulnerability record has been updated'
      })
      onSaved()
    } catch (error) {
      console.error('Error updating vulnerability:', error)
      toast({
        title: 'Error',
        description: 'Failed to update vulnerability',
        variant: 'destructive'
      })
    } finally {
      setSaving(false)
    }
  }

  const handleCreateTask = async (input: any) => {
    await createTask.mutateAsync({
      ...input,
      sourceType: 'vulnerability',
      sourceId: vulnerability.id,
      clientId: vulnerability.client_id || input.clientId,
      assignedTo: formData.assigned_to || input.assignedTo,
    })
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b flex items-center justify-between">
          <div>
            <h2 className="text-lg font-semibold">Vulnerability Details</h2>
            <p className="text-sm text-gray-500">{getClientName()}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            <X className="h-5 w-5" />
          </button>
        </div>

        <div className="px-6 py-4">
          <StatusPipeline stages={WORKFLOW_CONFIGS.vulnerability.stages} currentStage={formData.status} />
        </div>

        <div className="p-6 space-y-6">
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div className="bg-gray-50 p-3 rounded-lg">
              <p className="text-xs text-gray-500 uppercase">Type</p>
              <p className="font-medium">{getTypeLabel(vulnerability.vulnerability_type)}</p>
            </div>
            <div className="bg-gray-50 p-3 rounded-lg">
              <p className="text-xs text-gray-500 uppercase">Assessed</p>
              <p className="font-medium">{formatDate(vulnerability.assessment_date)}</p>
            </div>
            <div className="bg-gray-50 p-3 rounded-lg">
              <p className="text-xs text-gray-500 uppercase">Created</p>
              <p className="font-medium">{formatDate(vulnerability.created_at)}</p>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select
                value={formData.status}
                onChange={(e) => setFormData({ ...formData, status: e.target.value as any })}
                className="w-full border rounded-lg p-2 text-sm"
              >
                <option value="active">Active</option>
                <option value="monitoring">Monitoring</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Severity</label>
              <select
                value={formData.severity}
                onChange={(e) => setFormData({ ...formData, severity: e.target.value as any })}
                className="w-full border rounded-lg p-2 text-sm"
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <div className="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Assigned To</label>
              <OwnerPicker
                value={formData.assigned_to || null}
                onChange={(value) => setFormData({ ...formData, assigned_to: value || '' })}
                compact
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
              <select
                value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: e.target.value as Vulnerability['priority'] })}
                className="w-full border rounded-lg p-2 text-sm"
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Describe the vulnerability..."
              className="w-full border rounded-lg p-2 text-sm min-h-[80px]"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Support Measures</label>
            <textarea
              value={formData.support_measures}
              onChange={(e) => setFormData({ ...formData, support_measures: e.target.value })}
              placeholder="What support measures are in place?"
              className="w-full border rounded-lg p-2 text-sm min-h-[80px]"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Review Frequency</label>
              <select
                value={formData.review_frequency}
                onChange={(e) => setFormData({ ...formData, review_frequency: e.target.value as any })}
                className="w-full border rounded-lg p-2 text-sm"
              >
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annually">Annually</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Next Review Date</label>
              <input
                type="date"
                value={formData.next_review_date}
                onChange={(e) => setFormData({ ...formData, next_review_date: e.target.value })}
                className="w-full border rounded-lg p-2 text-sm"
              />
            </div>
          </div>
        </div>

        <div className="p-6 border-t bg-gray-50 flex justify-end space-x-3">
          <Button variant="outline" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSave} disabled={saving}>
            {saving ? 'Saving...' : 'Save Changes'}
          </Button>
        </div>
      </div>

      <CreateTaskModal
        open={showTaskModal}
        onOpenChange={setShowTaskModal}
        onSubmit={handleCreateTask}
        defaultClientId={vulnerability.client_id || undefined}
        defaultAssigneeId={formData.assigned_to || undefined}
      />
    </div>
  )
}

export { VulnerabilityFormModal }
