// components/compliance/VulnerabilityWizard.tsx
// ================================================================
// Step-by-step Vulnerability Assessment Wizard
// FCA Consumer Duty compliant vulnerability identification
// ================================================================

'use client'

import React, { useState } from 'react'
import {
  Shield,
  Heart,
  Calendar,
  TrendingDown,
  Brain,
  ChevronRight,
  ChevronLeft,
  Check,
  X,
  AlertTriangle,
  Info,
  HelpCircle
} from 'lucide-react'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/Button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card'
import { Badge } from '@/components/ui/Badge'
import { useToast } from '@/hooks/use-toast'
import clientLogger from '@/lib/logging/clientLogger'

interface Props {
  clientId: string
  clientName: string
  firmId?: string
  onComplete: () => void
  onCancel: () => void
  existingData?: {
    vulnerability_type?: string
    severity?: string
    description?: string
    support_measures?: string
  }
}

type VulnerabilityType = 'health' | 'life_events' | 'resilience' | 'capability'
type Severity = 'low' | 'medium' | 'high'

interface StepData {
  type: VulnerabilityType | null
  severity: Severity | null
  description: string
  supportMeasures: string[]
  reviewFrequency: 'monthly' | 'quarterly' | 'annually'
  additionalNotes: string
}

const VULNERABILITY_TYPES = [
  {
    id: 'health' as VulnerabilityType,
    label: 'Health',
    icon: Heart,
    description: 'Physical or mental health conditions that may affect decision-making or ability to manage finances',
    examples: ['Serious illness', 'Mental health condition', 'Physical disability', 'Cognitive impairment', 'Addiction']
  },
  {
    id: 'life_events' as VulnerabilityType,
    label: 'Life Events',
    icon: Calendar,
    description: 'Major life events causing stress or change in circumstances',
    examples: ['Bereavement', 'Divorce/separation', 'Job loss', 'Retirement', 'Caring responsibilities', 'Relationship breakdown']
  },
  {
    id: 'resilience' as VulnerabilityType,
    label: 'Resilience',
    icon: TrendingDown,
    description: 'Low financial or emotional resilience to withstand shocks',
    examples: ['Low savings/income', 'Debt problems', 'Irregular income', 'No emergency fund', 'Over-extended financially']
  },
  {
    id: 'capability' as VulnerabilityType,
    label: 'Capability',
    icon: Brain,
    description: 'Limited knowledge, skills, or confidence to manage finances effectively',
    examples: ['Low financial literacy', 'Language barriers', 'Digital exclusion', 'Limited experience with investments', 'Difficulty understanding complex products']
  }
]

const SEVERITY_OPTIONS = [
  {
    id: 'low' as Severity,
    label: 'Low',
    color: 'bg-green-100 text-green-800 border-green-300',
    description: 'Minor impact on ability to make financial decisions. Standard support measures sufficient.'
  },
  {
    id: 'medium' as Severity,
    label: 'Medium',
    color: 'bg-yellow-100 text-yellow-800 border-yellow-300',
    description: 'Moderate impact requiring additional support and more frequent review.'
  },
  {
    id: 'high' as Severity,
    label: 'High',
    color: 'bg-red-100 text-red-800 border-red-300',
    description: 'Significant impact requiring comprehensive support measures and close monitoring.'
  }
]

const SUPPORT_MEASURES: Record<VulnerabilityType, string[]> = {
  health: [
    'Allow extra time for decisions',
    'Offer written summaries of all recommendations',
    'Provide information in accessible formats',
    'Arrange video/phone meetings instead of in-person',
    'Include trusted family member or friend in discussions',
    'Schedule meetings at optimal times for client'
  ],
  life_events: [
    'Implement cooling-off period for major decisions',
    'Provide more frequent check-ins',
    'Offer emotional support resources',
    'Review all existing arrangements for suitability',
    'Consider temporary suspension of regular contributions',
    'Provide clear, simple communication'
  ],
  resilience: [
    'Review emergency fund adequacy',
    'Assess debt management needs',
    'Consider income protection options',
    'Review withdrawal strategy for flexibility',
    'Stress test financial plan',
    'Provide budgeting support resources'
  ],
  capability: [
    'Use plain English in all communications',
    'Provide glossary of financial terms',
    'Offer additional explanation time',
    'Use visual aids and diagrams',
    'Provide key information in writing',
    'Include trusted person in key meetings',
    'Follow up verbal discussions in writing'
  ]
}

export default function VulnerabilityWizard({
  clientId,
  clientName,
  firmId,
  onComplete,
  onCancel,
  existingData
}: Props) {
  const supabase = createClient()
  const { toast } = useToast()

  const [currentStep, setCurrentStep] = useState(1)
  const [saving, setSaving] = useState(false)
  const [data, setData] = useState<StepData>({
    type: (existingData?.vulnerability_type as VulnerabilityType) || null,
    severity: (existingData?.severity as Severity) || null,
    description: existingData?.description || '',
    supportMeasures: [],
    reviewFrequency: 'quarterly',
    additionalNotes: ''
  })

  const totalSteps = 4

  const handleNext = () => {
    if (currentStep < totalSteps) {
      setCurrentStep(currentStep + 1)
    }
  }

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1)
    }
  }

  const canProceed = () => {
    switch (currentStep) {
      case 1:
        return data.type !== null
      case 2:
        return data.severity !== null
      case 3:
        return data.supportMeasures.length > 0
      case 4:
        return true
      default:
        return false
    }
  }

  const handleSave = async () => {
    if (!data.type || !data.severity) return

    setSaving(true)
    try {
      // Calculate next review date
      const nextReviewDate = new Date()
      switch (data.reviewFrequency) {
        case 'monthly':
          nextReviewDate.setMonth(nextReviewDate.getMonth() + 1)
          break
        case 'quarterly':
          nextReviewDate.setMonth(nextReviewDate.getMonth() + 3)
          break
        case 'annually':
          nextReviewDate.setFullYear(nextReviewDate.getFullYear() + 1)
          break
      }

      // Insert into vulnerability_register
      const { error } = await supabase
        .from('vulnerability_register')
        .insert({
          firm_id: firmId || null,
          client_id: clientId,
          assessment_date: new Date().toISOString().split('T')[0],
          vulnerability_type: data.type,
          severity: data.severity,
          description: data.description || `${data.type} vulnerability identified`,
          support_measures: data.supportMeasures.join('\n'),
          review_frequency: data.reviewFrequency,
          next_review_date: nextReviewDate.toISOString().split('T')[0],
          status: 'active'
        })

      if (error) throw error

      // Also update the client's vulnerability_assessment field
      const { error: clientError } = await supabase
        .from('clients')
        .update({
          vulnerability_assessment: {
            is_vulnerable: true,
            vulnerabilityFactors: [data.type],
            assessmentDate: new Date().toISOString(),
            reviewDate: nextReviewDate.toISOString(),
            assessmentNotes: data.additionalNotes || data.description,
            supportNeeds: data.supportMeasures
          }
        })
        .eq('id', clientId)

      if (clientError) {
        clientLogger.error('Error updating client:', clientError)
      }

      toast({
        title: 'Vulnerability Recorded',
        description: `Assessment saved for ${clientName}. Review scheduled for ${nextReviewDate.toLocaleDateString('en-GB')}.`
      })

      onComplete()
    } catch (error) {
      clientLogger.error('Error saving vulnerability:', error)
      toast({
        title: 'Error',
        description: 'Failed to save vulnerability assessment',
        variant: 'destructive'
      })
    } finally {
      setSaving(false)
    }
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="p-6 border-b">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-lg font-semibold">Vulnerability Assessment</h2>
              <p className="text-sm text-gray-500">Recording vulnerability for {clientName}</p>
            </div>
            <button onClick={onCancel} className="p-2 hover:bg-gray-100 rounded-lg">
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Progress Bar */}
          <div className="mt-4">
            <div className="flex items-center justify-between text-xs text-gray-500 mb-1">
              <span>Step {currentStep} of {totalSteps}</span>
              <span>{Math.round((currentStep / totalSteps) * 100)}% complete</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className="bg-blue-600 h-2 rounded-full transition-all"
                style={{ width: `${(currentStep / totalSteps) * 100}%` }}
              />
            </div>
          </div>
        </div>

        <div className="p-6">
          {/* Step 1: Select Type */}
          {currentStep === 1 && (
            <div className="space-y-4">
              <div className="flex items-center space-x-2 mb-4">
                <Shield className="h-5 w-5 text-blue-600" />
                <h3 className="font-semibold">Step 1: Identify Vulnerability Type</h3>
              </div>
              <p className="text-sm text-gray-600 mb-4">
                Select the primary type of vulnerability that applies to this client. This follows the FCA Consumer Duty framework.
              </p>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {VULNERABILITY_TYPES.map((type) => {
                  const Icon = type.icon
                  const isSelected = data.type === type.id

                  return (
                    <button
                      key={type.id}
                      onClick={() => setData({ ...data, type: type.id })}
                      className={`p-4 rounded-lg border-2 text-left transition-all ${
                        isSelected
                          ? 'border-blue-600 bg-blue-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-start space-x-3">
                        <div className={`p-2 rounded-lg ${isSelected ? 'bg-blue-100' : 'bg-gray-100'}`}>
                          <Icon className={`h-5 w-5 ${isSelected ? 'text-blue-600' : 'text-gray-600'}`} />
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center justify-between">
                            <h4 className="font-medium">{type.label}</h4>
                            {isSelected && <Check className="h-5 w-5 text-blue-600" />}
                          </div>
                          <p className="text-xs text-gray-500 mt-1">{type.description}</p>
                          <div className="mt-2 flex flex-wrap gap-1">
                            {type.examples.slice(0, 3).map((example, i) => (
                              <Badge key={i} variant="outline" className="text-xs">
                                {example}
                              </Badge>
                            ))}
                          </div>
                        </div>
                      </div>
                    </button>
                  )
                })}
              </div>
            </div>
          )}

          {/* Step 2: Assess Severity */}
          {currentStep === 2 && (
            <div className="space-y-4">
              <div className="flex items-center space-x-2 mb-4">
                <AlertTriangle className="h-5 w-5 text-blue-600" />
                <h3 className="font-semibold">Step 2: Assess Severity</h3>
              </div>
              <p className="text-sm text-gray-600 mb-4">
                How significantly does this vulnerability impact the client&apos;s ability to make financial decisions?
              </p>

              <div className="space-y-3">
                {SEVERITY_OPTIONS.map((option) => {
                  const isSelected = data.severity === option.id

                  return (
                    <button
                      key={option.id}
                      onClick={() => setData({ ...data, severity: option.id })}
                      className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                        isSelected
                          ? `${option.color} border-current`
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div>
                          <h4 className="font-medium">{option.label} Severity</h4>
                          <p className="text-sm mt-1 opacity-80">{option.description}</p>
                        </div>
                        {isSelected && <Check className="h-5 w-5" />}
                      </div>
                    </button>
                  )
                })}
              </div>

              {/* Description field */}
              <div className="mt-6">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Description (Optional)
                </label>
                <textarea
                  value={data.description}
                  onChange={(e) => setData({ ...data, description: e.target.value })}
                  placeholder="Provide additional context about this vulnerability..."
                  className="w-full border rounded-lg p-3 text-sm min-h-[80px]"
                />
              </div>
            </div>
          )}

          {/* Step 3: Support Measures */}
          {currentStep === 3 && data.type && (
            <div className="space-y-4">
              <div className="flex items-center space-x-2 mb-4">
                <HelpCircle className="h-5 w-5 text-blue-600" />
                <h3 className="font-semibold">Step 3: Select Support Measures</h3>
              </div>
              <p className="text-sm text-gray-600 mb-4">
                Choose the support measures that will be implemented for this client. Select all that apply.
              </p>

              <div className="space-y-2">
                {SUPPORT_MEASURES[data.type].map((measure, index) => {
                  const isSelected = data.supportMeasures.includes(measure)

                  return (
                    <button
                      key={index}
                      onClick={() => {
                        if (isSelected) {
                          setData({
                            ...data,
                            supportMeasures: data.supportMeasures.filter(m => m !== measure)
                          })
                        } else {
                          setData({
                            ...data,
                            supportMeasures: [...data.supportMeasures, measure]
                          })
                        }
                      }}
                      className={`w-full p-3 rounded-lg border text-left flex items-center space-x-3 transition-all ${
                        isSelected
                          ? 'border-blue-600 bg-blue-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className={`w-5 h-5 rounded flex items-center justify-center ${
                        isSelected ? 'bg-blue-600' : 'border-2 border-gray-300'
                      }`}>
                        {isSelected && <Check className="h-3 w-3 text-white" />}
                      </div>
                      <span className="text-sm">{measure}</span>
                    </button>
                  )
                })}
              </div>

              {/* Review Frequency */}
              <div className="mt-6">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Review Frequency
                </label>
                <div className="flex space-x-3">
                  {(['monthly', 'quarterly', 'annually'] as const).map((freq) => (
                    <button
                      key={freq}
                      onClick={() => setData({ ...data, reviewFrequency: freq })}
                      className={`px-4 py-2 rounded-lg border text-sm capitalize ${
                        data.reviewFrequency === freq
                          ? 'border-blue-600 bg-blue-50 text-blue-700'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      {freq}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Step 4: Confirmation */}
          {currentStep === 4 && data.type && data.severity && (
            <div className="space-y-4">
              <div className="flex items-center space-x-2 mb-4">
                <Check className="h-5 w-5 text-blue-600" />
                <h3 className="font-semibold">Step 4: Review & Confirm</h3>
              </div>

              <Card className="bg-gray-50">
                <CardContent className="p-4 space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Vulnerability Type</p>
                      <p className="font-medium capitalize">{data.type.replace('_', ' ')}</p>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Severity</p>
                      <Badge className={SEVERITY_OPTIONS.find(s => s.id === data.severity)?.color}>
                        {data.severity}
                      </Badge>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Review Frequency</p>
                      <p className="font-medium capitalize">{data.reviewFrequency}</p>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Support Measures</p>
                      <p className="font-medium">{data.supportMeasures.length} selected</p>
                    </div>
                  </div>

                  {data.description && (
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Description</p>
                      <p className="text-sm mt-1">{data.description}</p>
                    </div>
                  )}

                  <div>
                    <p className="text-xs text-gray-500 uppercase mb-2">Selected Support Measures</p>
                    <ul className="text-sm space-y-1">
                      {data.supportMeasures.map((measure, i) => (
                        <li key={i} className="flex items-center space-x-2">
                          <Check className="h-4 w-4 text-green-600" />
                          <span>{measure}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </CardContent>
              </Card>

              {/* Additional Notes */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Additional Notes (Optional)
                </label>
                <textarea
                  value={data.additionalNotes}
                  onChange={(e) => setData({ ...data, additionalNotes: e.target.value })}
                  placeholder="Any other relevant information..."
                  className="w-full border rounded-lg p-3 text-sm min-h-[80px]"
                />
              </div>

              {/* FCA Notice */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div className="flex items-start space-x-3">
                  <Info className="h-5 w-5 text-blue-600 mt-0.5" />
                  <div className="text-sm text-blue-800">
                    <p className="font-medium">Consumer Duty Compliance</p>
                    <p className="mt-1">
                      This assessment will be recorded in the Vulnerability Register and the client&apos;s profile
                      will be updated. The selected support measures should be implemented immediately and
                      reviewed at the specified frequency.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-6 border-t bg-gray-50 flex justify-between">
          <Button variant="outline" onClick={currentStep === 1 ? onCancel : handleBack}>
            {currentStep === 1 ? 'Cancel' : (
              <>
                <ChevronLeft className="h-4 w-4 mr-1" />
                Back
              </>
            )}
          </Button>

          {currentStep < totalSteps ? (
            <Button onClick={handleNext} disabled={!canProceed()}>
              Next
              <ChevronRight className="h-4 w-4 ml-1" />
            </Button>
          ) : (
            <Button onClick={handleSave} disabled={saving || !canProceed()}>
              {saving ? 'Saving...' : 'Save Assessment'}
            </Button>
          )}
        </div>
      </div>
    </div>
  )
}
