// ================================================================
// src/components/stress-testing/VulnerabilityBreakdown.tsx
// Shows SPECIFIC vulnerabilities and why the score is what it is
// Breaks down the factors driving the resilience score
// ================================================================

'use client';

import React, { useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import {
  AlertTriangle,
  TrendingDown,
  Clock,
  Wallet,
  PiggyBank,
  Briefcase,
  Heart,
  Shield,
  Target,
  ArrowRight,
  ChevronRight
} from 'lucide-react';

interface StressTestResult {
  scenarioId: string;
  scenarioName: string;
  survivalProbability: number;
  shortfallRisk: number;
  resilienceScore: number;
  worstCaseOutcome: number;
  recoveryTimeYears?: number;
  impactAnalysis: {
    portfolioDeclinePercent: number;
    incomeReductionPercent: number;
    expenseIncreasePercent: number;
  };
}

interface ClientProfile {
  clientName: string;
  portfolioValue: number;
  annualIncome: number;
  annualExpenses: number;
  pensionValue: number;
  savings: number;
  age: number;
  retirementAge?: number;
  riskScore?: number;
}

interface Vulnerability {
  id: string;
  title: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  icon: React.ElementType;
  metric: string;
  metricValue: string;
  threshold: string;
  explanation: string;
  mitigation: string;
  affectedScenarios: string[];
}

interface VulnerabilityBreakdownProps {
  results: StressTestResult[];
  clientProfile: ClientProfile;
}

const formatCurrency = (value: number): string => {
  if (value >= 1000000) {
    return `£${(value / 1000000).toFixed(1)}M`;
  }
  if (value >= 1000) {
    return `£${(value / 1000).toFixed(0)}K`;
  }
  return `£${value.toLocaleString()}`;
};

export const VulnerabilityBreakdown: React.FC<VulnerabilityBreakdownProps> = ({
  results,
  clientProfile
}) => {
  const vulnerabilities = useMemo(() => {
    const vulns: Vulnerability[] = [];

    if (results.length === 0) return vulns;

    // Calculate key metrics
    const avgSurvival = results.reduce((sum, r) => sum + r.survivalProbability, 0) / results.length;
    const avgShortfall = results.reduce((sum, r) => sum + r.shortfallRisk, 0) / results.length;
    const maxDecline = Math.max(...results.map(r => r.impactAnalysis.portfolioDeclinePercent));
    const avgRecovery = results.filter(r => r.recoveryTimeYears).reduce((sum, r) => sum + (r.recoveryTimeYears || 0), 0) / results.length;
    const worstCaseValue = Math.min(...results.map(r => r.worstCaseOutcome));

    // Calculate cash runway
    const monthlyCashBurn = clientProfile.annualExpenses / 12;
    const cashRunwayMonths = clientProfile.savings / monthlyCashBurn;

    // Calculate years to retirement
    const yearsToRetirement = clientProfile.retirementAge
      ? Math.max(0, clientProfile.retirementAge - clientProfile.age)
      : 20;

    // Net worth
    const totalWealth = clientProfile.portfolioValue + clientProfile.pensionValue + clientProfile.savings;

    // Find critical scenarios
    const criticalScenarios = results.filter(r => r.resilienceScore < 50);
    const lowSurvivalScenarios = results.filter(r => r.survivalProbability < 60);
    const highDeclineScenarios = results.filter(r => r.impactAnalysis.portfolioDeclinePercent > 40);
    const longRecoveryScenarios = results.filter(r => (r.recoveryTimeYears || 0) > 4);
    const incomeShockScenarios = results.filter(r => r.impactAnalysis.incomeReductionPercent > 30);

    // 1. SURVIVAL PROBABILITY RISK
    if (avgSurvival < 70) {
      vulns.push({
        id: 'survival',
        title: 'Low Survival Probability',
        severity: avgSurvival < 50 ? 'critical' : avgSurvival < 60 ? 'high' : 'medium',
        icon: AlertTriangle,
        metric: 'Average Survival Rate',
        metricValue: `${avgSurvival.toFixed(0)}%`,
        threshold: 'Target: >75%',
        explanation: `Across the tested scenarios, there's only a ${avgSurvival.toFixed(0)}% chance the portfolio survives without running out of money. This means in ${(100 - avgSurvival).toFixed(0)}% of simulated outcomes, funds would be depleted before the end of the planning period.`,
        mitigation: 'Reduce withdrawal rate, increase contributions, or shift to more conservative investments to improve survival odds.',
        affectedScenarios: lowSurvivalScenarios.map(s => s.scenarioName)
      });
    }

    // 2. HIGH SHORTFALL RISK
    if (avgShortfall > 25) {
      vulns.push({
        id: 'shortfall',
        title: 'Significant Shortfall Risk',
        severity: avgShortfall > 50 ? 'critical' : avgShortfall > 35 ? 'high' : 'medium',
        icon: TrendingDown,
        metric: 'Average Shortfall Risk',
        metricValue: `${avgShortfall.toFixed(0)}%`,
        threshold: 'Target: <20%',
        explanation: `There's a ${avgShortfall.toFixed(0)}% probability of experiencing a funding shortfall - meaning expenses would exceed available funds. The average shortfall amount could be significant.`,
        mitigation: 'Build larger cash reserves, reduce fixed expenses, or establish flexible spending rules that adjust to market conditions.',
        affectedScenarios: results.filter(r => r.shortfallRisk > 30).map(s => s.scenarioName)
      });
    }

    // 3. SEVERE PORTFOLIO DECLINE EXPOSURE
    if (maxDecline > 35) {
      vulns.push({
        id: 'drawdown',
        title: 'Severe Drawdown Exposure',
        severity: maxDecline > 50 ? 'critical' : maxDecline > 40 ? 'high' : 'medium',
        icon: TrendingDown,
        metric: 'Maximum Portfolio Decline',
        metricValue: `-${maxDecline.toFixed(0)}%`,
        threshold: 'Risk limit: <30%',
        explanation: `In the worst scenario, the portfolio could drop by ${maxDecline.toFixed(0)}% - a loss of ${formatCurrency(clientProfile.portfolioValue * (maxDecline / 100))}. This level of decline can be psychologically difficult and may force selling at the worst time.`,
        mitigation: 'Reduce equity allocation, add hedging positions, or implement a dynamic asset allocation strategy that reduces risk in downturns.',
        affectedScenarios: highDeclineScenarios.map(s => s.scenarioName)
      });
    }

    // 4. INADEQUATE CASH BUFFER
    if (cashRunwayMonths < 12) {
      vulns.push({
        id: 'cash-buffer',
        title: 'Inadequate Emergency Cash Buffer',
        severity: cashRunwayMonths < 6 ? 'critical' : cashRunwayMonths < 9 ? 'high' : 'medium',
        icon: PiggyBank,
        metric: 'Cash Runway',
        metricValue: `${cashRunwayMonths.toFixed(0)} months`,
        threshold: 'Target: 12-24 months',
        explanation: `Current savings (${formatCurrency(clientProfile.savings)}) would only cover ${cashRunwayMonths.toFixed(0)} months of expenses at ${formatCurrency(monthlyCashBurn)}/month. Without adequate cash reserves, you may be forced to sell investments during a downturn.`,
        mitigation: `Build emergency fund to ${formatCurrency(clientProfile.annualExpenses * 1.5)} (18 months of expenses) to avoid forced selling during stress periods.`,
        affectedScenarios: ['All scenarios - affects recovery flexibility']
      });
    }

    // 5. LONG RECOVERY TIME
    if (avgRecovery > 3 && yearsToRetirement < avgRecovery * 2) {
      vulns.push({
        id: 'recovery-time',
        title: 'Extended Recovery Period',
        severity: avgRecovery > 5 ? 'high' : 'medium',
        icon: Clock,
        metric: 'Average Recovery Time',
        metricValue: `${avgRecovery.toFixed(1)} years`,
        threshold: 'Concern if >3 years',
        explanation: `On average, it would take ${avgRecovery.toFixed(1)} years to recover from these stress events. With ${yearsToRetirement} years to retirement, there may not be enough time to fully recover from a major setback.`,
        mitigation: 'Consider reducing portfolio volatility as retirement approaches, or maintain higher cash allocation to reduce sequence of returns risk.',
        affectedScenarios: longRecoveryScenarios.map(s => s.scenarioName)
      });
    }

    // 6. INCOME DEPENDENCY RISK
    if (incomeShockScenarios.length > 0) {
      const maxIncomeHit = Math.max(...results.map(r => r.impactAnalysis.incomeReductionPercent));
      const incomeAtRisk = clientProfile.annualIncome * (maxIncomeHit / 100);

      if (maxIncomeHit > 30) {
        vulns.push({
          id: 'income-dependency',
          title: 'High Income Dependency',
          severity: maxIncomeHit > 50 ? 'high' : 'medium',
          icon: Briefcase,
          metric: 'Potential Income Loss',
          metricValue: `-${maxIncomeHit.toFixed(0)}%`,
          threshold: `${formatCurrency(incomeAtRisk)}/year at risk`,
          explanation: `Personal crisis scenarios could reduce income by up to ${maxIncomeHit.toFixed(0)}% (${formatCurrency(incomeAtRisk)}/year). The current plan heavily relies on continued income.`,
          mitigation: 'Consider income protection insurance, build passive income streams, or ensure spouse/partner income can cover essential expenses.',
          affectedScenarios: incomeShockScenarios.map(s => s.scenarioName)
        });
      }
    }

    // 7. EXPENSE SPIKE VULNERABILITY
    const maxExpenseIncrease = Math.max(...results.map(r => r.impactAnalysis.expenseIncreasePercent));
    if (maxExpenseIncrease > 30) {
      const additionalExpense = clientProfile.annualExpenses * (maxExpenseIncrease / 100);
      vulns.push({
        id: 'expense-spike',
        title: 'Vulnerable to Expense Spikes',
        severity: maxExpenseIncrease > 50 ? 'high' : 'medium',
        icon: Heart,
        metric: 'Potential Expense Increase',
        metricValue: `+${maxExpenseIncrease.toFixed(0)}%`,
        threshold: `+${formatCurrency(additionalExpense)}/year`,
        explanation: `Health events or other crises could increase annual expenses by ${maxExpenseIncrease.toFixed(0)}% (${formatCurrency(additionalExpense)}). This could rapidly deplete savings during an already stressful period.`,
        mitigation: 'Ensure adequate health insurance, consider critical illness cover, and maintain flexible spending capacity.',
        affectedScenarios: results.filter(r => r.impactAnalysis.expenseIncreasePercent > 25).map(s => s.scenarioName)
      });
    }

    // 8. WORST CASE OUTCOME
    const worstCaseLoss = clientProfile.portfolioValue - worstCaseValue;
    const worstCaseLossPercent = (worstCaseLoss / clientProfile.portfolioValue) * 100;
    if (worstCaseLossPercent > 40) {
      vulns.push({
        id: 'worst-case',
        title: 'Severe Worst-Case Outcome',
        severity: worstCaseLossPercent > 60 ? 'critical' : 'high',
        icon: Target,
        metric: 'Worst Case Portfolio Value',
        metricValue: formatCurrency(worstCaseValue),
        threshold: `Loss of ${formatCurrency(worstCaseLoss)}`,
        explanation: `In the most extreme scenario, the portfolio could fall to ${formatCurrency(worstCaseValue)} - a loss of ${worstCaseLossPercent.toFixed(0)}% from current value. This represents a significant setback to financial goals.`,
        mitigation: 'Review risk tolerance, consider tail-risk hedging, or establish floor value protection strategies.',
        affectedScenarios: [results.find(r => r.worstCaseOutcome === worstCaseValue)?.scenarioName || 'Worst scenario']
      });
    }

    // 9. SEQUENCE OF RETURNS RISK (if close to retirement)
    if (yearsToRetirement <= 10 && maxDecline > 30) {
      vulns.push({
        id: 'sequence-risk',
        title: 'Sequence of Returns Risk',
        severity: yearsToRetirement <= 5 ? 'high' : 'medium',
        icon: Clock,
        metric: 'Years to Retirement',
        metricValue: `${yearsToRetirement} years`,
        threshold: 'Critical window: 5 years before/after retirement',
        explanation: `With ${yearsToRetirement} years until retirement, a major market decline now could permanently impair retirement income. Poor returns in the years just before and after retirement have an outsized negative impact.`,
        mitigation: 'Consider a "glide path" strategy reducing equity exposure as retirement approaches, and establish a 3-5 year cash bucket for early retirement spending.',
        affectedScenarios: highDeclineScenarios.map(s => s.scenarioName)
      });
    }

    // Sort by severity
    const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
    return vulns.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
  }, [results, clientProfile]);

  if (vulnerabilities.length === 0) {
    return (
      <Card className="bg-green-50 border-green-200">
        <CardContent className="p-6">
          <div className="flex items-center gap-3">
            <Shield className="h-8 w-8 text-green-600" />
            <div>
              <h3 className="font-bold text-green-800">No Critical Vulnerabilities Detected</h3>
              <p className="text-green-700">The portfolio shows strong resilience across all tested scenarios.</p>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  }

  const severityColors = {
    critical: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', badge: 'bg-red-100 text-red-700' },
    high: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', badge: 'bg-orange-100 text-orange-700' },
    medium: { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', badge: 'bg-amber-100 text-amber-700' },
    low: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', badge: 'bg-blue-100 text-blue-700' }
  };

  const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
  const highCount = vulnerabilities.filter(v => v.severity === 'high').length;

  return (
    <Card className="border-2 border-gray-200">
      <CardHeader className="pb-2">
        <CardTitle className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-orange-500" />
            Vulnerability Analysis
          </div>
          <div className="flex gap-2">
            {criticalCount > 0 && (
              <Badge className="bg-red-100 text-red-700">{criticalCount} Critical</Badge>
            )}
            {highCount > 0 && (
              <Badge className="bg-orange-100 text-orange-700">{highCount} High</Badge>
            )}
          </div>
        </CardTitle>
        <p className="text-sm text-gray-600">
          Specific factors affecting your resilience score
        </p>
      </CardHeader>
      <CardContent className="space-y-4">
        {vulnerabilities.map((vuln) => {
          const colors = severityColors[vuln.severity];
          const VulnIcon = vuln.icon;

          return (
            <div
              key={vuln.id}
              className={`p-4 rounded-lg border ${colors.bg} ${colors.border}`}
            >
              {/* Header */}
              <div className="flex items-start justify-between mb-3">
                <div className="flex items-center gap-2">
                  <VulnIcon className={`h-5 w-5 ${colors.text}`} />
                  <h4 className={`font-semibold ${colors.text}`}>{vuln.title}</h4>
                </div>
                <Badge className={colors.badge}>{vuln.severity.toUpperCase()}</Badge>
              </div>

              {/* Metrics */}
              <div className="grid grid-cols-2 gap-4 mb-3">
                <div className="bg-white/60 rounded p-2">
                  <p className="text-xs text-gray-500">{vuln.metric}</p>
                  <p className={`text-lg font-bold ${colors.text}`}>{vuln.metricValue}</p>
                </div>
                <div className="bg-white/60 rounded p-2">
                  <p className="text-xs text-gray-500">Benchmark</p>
                  <p className="text-sm font-medium text-gray-700">{vuln.threshold}</p>
                </div>
              </div>

              {/* Explanation */}
              <p className="text-sm text-gray-700 mb-3">{vuln.explanation}</p>

              {/* Affected Scenarios */}
              {vuln.affectedScenarios.length > 0 && (
                <div className="mb-3">
                  <p className="text-xs text-gray-500 mb-1">Affected Scenarios:</p>
                  <div className="flex flex-wrap gap-1">
                    {vuln.affectedScenarios.slice(0, 3).map((scenario, idx) => (
                      <Badge key={idx} variant="outline" className="text-xs">
                        {scenario}
                      </Badge>
                    ))}
                    {vuln.affectedScenarios.length > 3 && (
                      <Badge variant="outline" className="text-xs">
                        +{vuln.affectedScenarios.length - 3} more
                      </Badge>
                    )}
                  </div>
                </div>
              )}

              {/* Mitigation */}
              <div className="bg-white/80 rounded p-3 border border-gray-200">
                <div className="flex items-start gap-2">
                  <ChevronRight className="h-4 w-4 text-green-600 mt-0.5 flex-shrink-0" />
                  <div>
                    <p className="text-xs font-medium text-green-700 mb-1">Recommended Action</p>
                    <p className="text-sm text-gray-700">{vuln.mitigation}</p>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </CardContent>
    </Card>
  );
};

export default VulnerabilityBreakdown;
