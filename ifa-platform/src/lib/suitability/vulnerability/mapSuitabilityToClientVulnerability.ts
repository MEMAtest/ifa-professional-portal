import type { SuitabilityFormData } from '@/types/suitability'

type VulnerabilityType = 'health' | 'life_events' | 'resilience' | 'capability'

export type ClientVulnerabilityAssessment = {
  is_vulnerable: boolean
  vulnerabilityFactors: VulnerabilityType[]
  supportNeeds: string[]
  assessmentNotes: string
  assessmentDate: string
  reviewDate: string
  assessorId?: string
  source?: 'suitability'
}

function parseOptionalNumber(value: unknown): number | undefined {
  if (value === null || value === undefined) return undefined
  if (typeof value === 'number') return Number.isFinite(value) ? value : undefined
  if (typeof value === 'string') {
    const trimmed = value.trim()
    if (!trimmed) return undefined
    const parsed = Number(trimmed.replace(/,/g, ''))
    return Number.isFinite(parsed) ? parsed : undefined
  }
  return undefined
}

function addMonthsISO(dateISO: string, months: number): string {
  const base = new Date(dateISO)
  if (Number.isNaN(base.getTime())) return new Date().toISOString()
  base.setMonth(base.getMonth() + months)
  return base.toISOString()
}

function normalizeStringArray(value: unknown): string[] {
  if (!Array.isArray(value)) return []
  return value
    .map((v) => (typeof v === 'string' ? v.trim() : String(v)))
    .filter((v) => v.length > 0)
}

export function mapSuitabilityToClientVulnerability(params: {
  formData: SuitabilityFormData
  nowISO: string
  assessorId?: string
}): ClientVulnerabilityAssessment {
  const { formData, nowISO, assessorId } = params

  const personal = (formData.personal_information || {}) as any
  const financial = (formData.financial_situation || {}) as any
  const vuln = (formData.vulnerability_assessment || {}) as any

  const age = parseOptionalNumber(personal.age) ?? 0

  const monthlyExpenses = parseOptionalNumber(financial.monthly_expenses)
  const emergencyFund = parseOptionalNumber(financial.emergency_fund)
  const netWorth =
    parseOptionalNumber(financial.net_worth) ??
    parseOptionalNumber(financial.netWorth) ??
    parseOptionalNumber(financial.total_net_worth)

  const emergencyMonths =
    monthlyExpenses && monthlyExpenses > 0 && emergencyFund !== undefined
      ? Math.floor(emergencyFund / monthlyExpenses)
      : undefined

  const healthConditions = String(vuln.health_conditions || '').toLowerCase()
  const legacyHealthConcerns = String(vuln.health_concerns || '').toLowerCase()
  const hasHealth =
    healthConditions === 'yes' ||
    legacyHealthConcerns.includes('moderate') ||
    legacyHealthConcerns.includes('significant') ||
    typeof vuln.cognitive_ability === 'string'

  const lifeEvents = normalizeStringArray(vuln.life_events).filter((e) => e.toLowerCase() !== 'none')
  const hasLifeEvents = lifeEvents.length > 0

  const confidence = String(vuln.financial_confidence || '').toLowerCase()
  const hasCapability =
    confidence === 'very low' ||
    confidence === 'low' ||
    String(vuln.third_party_authority || '').toLowerCase() === 'yes' ||
    String(vuln.cognitive_ability || '').toLowerCase().includes('assistance') ||
    String(vuln.cognitive_ability || '').toLowerCase().includes('support')

  const hasResilience =
    (typeof emergencyMonths === 'number' && emergencyMonths < 3) ||
    (typeof netWorth === 'number' && netWorth > 0 && netWorth < 50000) ||
    (typeof (financial.monthly_surplus as any) === 'number' && (financial.monthly_surplus as number) < 0)

  const vulnerabilityFactors = Array.from(
    new Set<VulnerabilityType>(
      [
        hasHealth ? 'health' : null,
        hasLifeEvents ? 'life_events' : null,
        hasResilience ? 'resilience' : null,
        hasCapability ? 'capability' : null
      ].filter(Boolean) as VulnerabilityType[]
    )
  )

  const supportNeeds = Array.from(
    new Set(
      [
        ...normalizeStringArray(vuln.support_needed).filter((e) => e.toLowerCase() !== 'none'),
        ...normalizeStringArray(vuln.communication_preferences).filter((e) => e.toLowerCase() !== 'none'),
        ...normalizeStringArray(vuln.emotional_support).filter((e) => e.toLowerCase() !== 'none')
      ].filter(Boolean)
    )
  )

  const notesParts = [
    typeof vuln.vulnerability_notes === 'string' ? vuln.vulnerability_notes : '',
    typeof vuln.support_person === 'string' ? `Support person: ${vuln.support_person}` : '',
    typeof vuln.other_life_event === 'string' ? `Other life event: ${vuln.other_life_event}` : '',
    typeof vuln.cooling_off_period === 'string' ? `Cooling-off preference: ${vuln.cooling_off_period}` : '',
    lifeEvents.length ? `Life events: ${lifeEvents.join(', ')}` : ''
  ].filter((p) => typeof p === 'string' && p.trim().length > 0) as string[]

  const assessmentNotes = notesParts.join('\n')

  const isVulnerable = vulnerabilityFactors.length > 0

  // Review cadence:
  // - frequent (3 months): health, life events, age>75, low net worth
  // - enhanced (6 months): other vulnerabilities
  // - standard (12 months): not vulnerable
  const frequent =
    hasHealth ||
    hasLifeEvents ||
    age > 75 ||
    (typeof netWorth === 'number' && netWorth > 0 && netWorth < 50000)

  const reviewDate = addMonthsISO(nowISO, isVulnerable ? (frequent ? 3 : 6) : 12)

  return {
    is_vulnerable: isVulnerable,
    vulnerabilityFactors,
    supportNeeds,
    assessmentNotes,
    assessmentDate: nowISO,
    reviewDate,
    assessorId,
    source: 'suitability'
  }
}

