import type { SuitabilityFormData } from '@/types/suitability'

import { asObject, asTrimmedString, safeArray } from '../utils'

export function buildVulnerabilitySummary(formData: SuitabilityFormData): {
  hasVulnerability: boolean
  vulnerabilityFlags: string[]
  accommodations: string[]
} {
  const formVulnerability = asObject(formData.vulnerability_assessment)

  const hasVulnerability =
    asTrimmedString(formVulnerability.health_conditions)?.toLowerCase() === 'yes' ||
    asTrimmedString(formVulnerability.health_concerns)?.toLowerCase().includes('significant') ||
    safeArray(formVulnerability.life_events).some((e) => String(e).toLowerCase() !== 'none') ||
    safeArray(formVulnerability.support_needed).some((e) => String(e).toLowerCase() !== 'none')

  const vulnerabilityFlags = [
    ...safeArray<string>(formVulnerability.life_events).filter((e) => String(e).toLowerCase() !== 'none'),
    asTrimmedString(formVulnerability.financial_confidence)
  ].filter(Boolean) as string[]

  const accommodations = safeArray<string>(formVulnerability.support_needed).filter((e) => String(e).toLowerCase() !== 'none')

  return { hasVulnerability, vulnerabilityFlags, accommodations }
}

